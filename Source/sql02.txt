DECLARE @S_DD DATETIME,@E_DD DATETIME,@A VARCHAR(200),@B VARCHAR(200),@C VARCHAR(200)
SET @S_DD=:DATE!起始日期  
SET @E_DD=:DATE!截止日期  
SET @A=:客户订单号   
SET @B=:受订单号  
SET @C=:客户名称  
SELECT COUNT(B.IC_NO) AS A,B.IC_NO,A.IZ_DD,A.IZ_NO
INTO #MF_IZ
 FROM MF_IZ A
 LEFT JOIN TF_IZ B ON B.IZ_NO=A.IZ_NO
 GROUP BY B.IC_NO,A.IZ_DD,A.IZ_NO
 SELECT (CASE WHEN 订单状态 IN ('订单结案','已配送','已到货,未销货','已销货,未审核','已销货') THEN 0 ELSE DATEDIFF(DAY,预交日期,GETDATE()) END) AS 到期天数,客户订单号,预交日期,销售订单号 AS '销售订单号JUMPTO[YHWIN]',销售订单日期,客户代号,客户名称,受订单号 AS '受订单号JUMPTO[SO]',
受订日期,配送单号 AS '配送单号JUMPTO[IO]',配送日期,到货确认单号 AS '到货确认单号JUMPTO[IZ]',到货确认日期,
销货单号 AS '销货单号JUMPTO[SA]',销货日期,订单状态
FROM (
SELECT  ISNULL(A.CUS_OS_NO,'') AS '客户订单号',
       A.EST_DD AS '预交日期',
		A.YH_NO AS '销售订单号',
		A.YH_DD AS '销售订单日期',
		A.CUS_NO AS '客户代号',
		CU.NAME AS '客户名称',
		B.OS_NO AS '受订单号',
		B.OS_DD AS '受订日期',
		C.IC_NO AS '配送单号'  ,
		C.IC_DD AS '配送日期',
		D.IZ_NO AS '到货确认单号'  ,
		D.IZ_DD AS '到货确认日期',
		E.PS_NO AS '销货单号'  ,
		E.PS_DD AS '销货日期',

(CASE WHEN B.OS_NO IS NULL THEN '未受订'
		WHEN B.OS_NO IS NOT NULL AND ISNULL(B.CHK_MAN,'')='' THEN '订单未审核'
		WHEN B.OS_NO IS NOT NULL AND ISNULL(B.CHK_MAN,'')<>'' AND C.IC_NO IS NULL AND B.CLS_ID='T' THEN '订单结案'
		WHEN B.OS_NO IS NOT NULL AND ISNULL(B.CHK_MAN,'')<>'' AND C.IC_NO IS NULL THEN '订单未配送' 
		WHEN C.IC_NO IS NOT NULL AND D.IZ_NO IS NULL THEN '已配送'
		WHEN D.IZ_NO IS NOT NULL AND E.PS_NO IS NULL THEN '已到货,未销货'
		WHEN E.PS_NO IS NOT NULL AND ISNULL(E.CHK_MAN,'')='' THEN '已销货,未审核'
		WHEN E.PS_NO IS NOT NULL AND ISNULL(E.CHK_MAN,'')<>'' THEN '已销货' END) AS '订单状态'
FROM MF_DYH A
LEFT JOIN MF_POS B ON B.YH_NO=A.YH_NO
LEFT JOIN MF_CK CK ON CK.OS_NO=B.OS_NO
LEFT JOIN MF_IC C ON C.BIL_NO=CK.OS_NO
LEFT JOIN #MF_IZ D ON D.IC_NO=C.IC_NO
LEFT JOIN MF_PSS E ON E.OS_NO=D.IZ_NO
LEFT JOIN CUST CU ON CU.CUS_NO=A.CUS_NO
WHERE A.YH_ID='YH'
UNION ALL
SELECT ISNULL(A.CUS_OS_NO,''),A.EST_DD,'无销售订单',NULL,A.CUS_NO,CU.NAME,A.OS_NO,A.OS_DD,B.IC_NO,B.IC_DD,C.IZ_NO,C.IZ_DD,
		D.PS_NO,D.PS_DD,
(CASE 	WHEN A.OS_NO IS NOT NULL AND ISNULL(A.CHK_MAN,'')='' THEN '订单未审核'
		WHEN A.OS_NO IS NOT NULL AND ISNULL(A.CHK_MAN,'')<>'' AND B.IC_NO IS NULL AND A.CLS_ID='T' THEN '订单结案'
		WHEN A.OS_NO IS NOT NULL AND ISNULL(A.CHK_MAN,'')<>'' AND B.IC_NO IS NULL THEN '订单未配送' 
		WHEN B.IC_NO IS NOT NULL AND C.IZ_NO IS NULL THEN '已配送'
		WHEN C.IZ_NO IS NOT NULL AND D.PS_NO IS NULL THEN '已到货，未销货'
		WHEN D.PS_NO IS NOT NULL AND ISNULL(D.CHK_MAN,'')='' THEN '已销货,未审核'
		WHEN D.PS_NO IS NOT NULL AND ISNULL(D.CHK_MAN,'')<>'' THEN '已销货' END) AS '订单状态'
FROM MF_POS A
LEFT JOIN MF_POS PS ON PS.YH_NO=A.YH_NO
LEFT JOIN MF_CK CK2 ON CK2.OS_NO=PS.OS_NO
LEFT JOIN MF_IC B ON B.IC_NO=PS.POS_NO
LEFT JOIN #MF_IZ C ON C.IC_NO=B.IC_NO
LEFT JOIN MF_PSS D ON D.OS_NO=CK2.CK_NO
LEFT JOIN CUST CU ON CU.CUS_NO=A.CUS_NO
WHERE ISNULL(A.YH_NO,'')='' AND A.OS_ID='SO'
)A
WHERE 客户订单号 LIKE '%'+@A+'%' AND 受订单号 LIKE '%'+@B+'%' AND 客户名称  LIKE '%'+@C+'%' AND 
	(CASE WHEN 销售订单日期 IS NULL THEN 受订日期 ELSE 销售订单日期 END)>=@S_DD AND 
	(CASE WHEN 销售订单日期 IS NULL THEN 受订日期 ELSE 销售订单日期 END)<=@E_DD
ORDER BY 销售订单号,销售订单日期

DROP TABLE #MF_IZ
